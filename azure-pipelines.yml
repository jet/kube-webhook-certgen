trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  GOVERSION:  '1.12.5'
  GOBIN:      '$(GOPATH)/bin'
  GOROOT:     '/usr/local/go'
  GOPATH:     '$(system.defaultWorkingDirectory)/gopath'
  modulePath: '$(GOPATH)/src/github.com/$(build.repository.name)'

steps:

- script: |
    wget https://dl.google.com/go/go$(GOVERSION).linux-amd64.tar.gz -q
    sudo tar -C /usr/local -xzf go$(GOVERSION).linux-amd64.tar.gz
    mkdir -p '$(GOBIN)'
    mkdir -p '$(GOPATH)/pkg'
    mkdir -p '$(modulePath)'
    shopt -s extglob
    shopt -s dotglob
    mv !(gopath) '$(modulePath)'
    echo '##vso[task.prependpath]$(GOBIN)'
    echo '##vso[task.prependpath]$(GOROOT)/bin'
  displayName: 'Set up Go'

- script: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v .
  workingDirectory: '$(modulePath)'
  displayName: 'Build'

- script: go test -v ./...
  displayName: 'Test'

- script: |
    ls -la
    docker build . -t jet/kube-webhook-certgen
  displayName: 'Build docker'

- script: docker run jet/kube-webhook-certgen version
  displayName: 'Test docker executes'

- task: PublishPipelineArtifact@0
  inputs:
    artifactName: 'kube-webhook-certgen'
    targetPath: 'kube-webhook-certgen'