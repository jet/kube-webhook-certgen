trigger:
- master

pool:
  vmImage: 'ubuntu-latest'

variables:
  GOBIN:  '$(GOPATH)/bin'
  GOROOT: '/usr/local/go'
  GOPATH: '$(system.defaultWorkingDirectory)/gopath'
  modulePath: '$(GOPATH)/src/github.com/$(build.repository.name)'

steps:

- script: |
    wget https://dl.google.com/go/go1.12.5.linux-amd64.tar.gz -q
    sudo tar -C /usr/local -xzf go1.12.5.linux-amd64.tar.gz
    mkdir -p '$(GOBIN)'
    mkdir -p '$(GOPATH)/pkg'
    mkdir -p '$(modulePath)'
    shopt -s extglob
    shopt -s dotglob
    mv !(gopath) '$(modulePath)'
    echo '##vso[task.prependpath]$(GOBIN)'
    echo '##vso[task.prependpath]$(GOROOT)/bin'
  displayName: 'Set up Go'

- script: CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -v .
  workingDirectory: '$(modulePath)'
  displayName: 'Build'

- script: go test -v ./...
  displayName: 'Test'

- script: |
    docker build . -t jet/kube-webhook-certgen
    docker run jet/kube-webhook-certgen version
  displayName: 'Build docker'
